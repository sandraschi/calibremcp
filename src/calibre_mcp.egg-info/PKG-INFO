Metadata-Version: 2.4
Name: calibre-mcp
Version: 1.0.0
Summary: FastMCP 2.13+ server for Calibre e-book library management with persistent storage
Home-page: https://github.com/sandraschi/calibremcp
Author: Sandra Schi
Author-email: Sandra <sandra@example.com>
License: MIT
Project-URL: Homepage, https://github.com/sandra/calibre-mcp
Project-URL: Repository, https://github.com/sandra/calibre-mcp.git
Project-URL: Issues, https://github.com/sandra/calibre-mcp/issues
Keywords: mcp,calibre,ebooks,fastmcp
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Requires-Python: >=3.8
Description-Content-Type: text/markdown
Requires-Dist: fastmcp>=2.13.0
Requires-Dist: fastapi>=0.115.0
Requires-Dist: httpx>=0.27.0
Requires-Dist: pydantic>=2.9.0
Requires-Dist: python-dotenv>=1.0.1
Requires-Dist: rich>=13.8.0
Requires-Dist: structlog>=24.4.0
Requires-Dist: sqlalchemy>=2.0.0
Requires-Dist: aiohttp>=3.9.0
Requires-Dist: keyring>=24.0.0
Requires-Dist: py-key-value-aio[disk]<0.3.0,>=0.2.8
Requires-Dist: tenacity>=8.2.0
Requires-Dist: psutil>=5.9.0
Provides-Extra: dev
Requires-Dist: pytest>=8.3.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.23.0; extra == "dev"
Requires-Dist: pytest-cov>=5.0.0; extra == "dev"
Requires-Dist: black>=24.0.0; extra == "dev"
Requires-Dist: ruff>=0.6.0; extra == "dev"
Requires-Dist: mypy>=1.11.0; extra == "dev"
Requires-Dist: bandit>=1.7.8; extra == "dev"
Requires-Dist: twine>=5.1.0; extra == "dev"
Requires-Dist: build>=1.2.0; extra == "dev"
Dynamic: author
Dynamic: home-page
Dynamic: requires-python

# CalibreMCP üìö

**FastMCP 2.13+ server for comprehensive Calibre e-book library management through Claude Desktop**

**Features:**
- **Portmanteau Tools** - Consolidated tools reducing tool count while maintaining full functionality
- **Default Library Auto-Loading** - No manual library setup needed
- **Comprehensive Search** - All verbs (search, list, find, query, get) work seamlessly
- **Verb Mapping** - Claude automatically maps user queries to correct operations

[![FastMCP](https://img.shields.io/badge/FastMCP-2.0-blue)](https://github.com/jlowin/fastmcp)
[![Python](https://img.shields.io/badge/Python-3.11+-green)](https://python.org)
[![Austrian Efficiency](https://img.shields.io/badge/Austrian-Efficiency-red)](https://en.wikipedia.org/wiki/Austrian_school)

*Austrian efficiency for Sandra's 1000+ book digital library. Built with realistic AI-assisted development timelines (days, not weeks).*

## üöÄ Quick Start

### **Prerequisites**

- **Python 3.11+** with pip
- **Calibre 6.0+** installed and running
- **Calibre Content Server** enabled on port 8080

### **Installation**

```bash
cd d:\dev\repos\calibremcp
pip install -e .
```

### **Start Calibre Server**

```bash
# Option 1: Through Calibre GUI
# Calibre ‚Üí Connect/share ‚Üí Start Content Server

# Option 2: Command line
calibre-server --port=8080
```

### **Test Connection**

```bash
python -c "
from calibre_mcp.calibre_api import quick_library_test
import asyncio
print('‚úÖ Working' if asyncio.run(quick_library_test()) else '‚ùå Failed')
"
```

### **Verify Server Will Load in Claude** ‚ö°

Before committing or restarting Claude, verify the server will load:

```bash
# Quick check (fast, recommended)
python scripts/quick_check.py

# Comprehensive check (includes linting)
python scripts/pre_commit_check.py

# Check recent logs for errors
python scripts/check_logs.py --errors-only
```

**Standardized Workflow (After "add tool to do x"):**

1. **Add tool** following all standards
2. **Run ruff iteratively** until zero errors:
   - `uv run ruff check .` ‚Üí Fix errors ‚Üí Run again ‚Üí Repeat until clean
   - `uv run ruff format .` (format after linting passes)
3. **Run pytest**: `uv run python -m pytest -v`
4. **Run restart script**: `.\scripts\restart_claude_and_check_mcp.ps1`

**Quick Check (Claude Already Running):**
```powershell
.\scripts\restart_claude_and_check_mcp.ps1 -NoRestart
```

**Full Restart & Check:**
```powershell
.\scripts\restart_claude_and_check_mcp.ps1
```

**Note:** 
- **SOTA Script** - Generic MCP server debugging script (copied from central docs repo)
- Uses `taskkill` to stop Claude (no UAC needed)
- Auto-detects server name, log file location, Claude path
- Checks only the **LAST** startup attempt (ignores older failures)
- See [MCP Development Workflow](docs/MCP_DEVELOPMENT_WORKFLOW.md) for complete process

### **Claude Desktop Integration**

Add to your `claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "calibre-mcp": {
      "command": "python",
      "args": ["-m", "calibre_mcp.server"],
      "env": {
        "CALIBRE_SERVER_URL": "http://localhost:8080"
      }
    }
  }
}
```

## Features

### Core Features
- **Advanced Search** - Powerful filtering and search capabilities:
  - Text search across titles, authors, series, tags, and comments
  - Filter by publication date and date added
  - File size and format filtering
  - Empty/non-empty comments
  - Star ratings (exact, minimum, or unrated)
  - Publisher filtering (single or multiple)
- **Full Library Access** - Browse and manage your entire Calibre collection
- **Smart Metadata** - Automatic metadata enhancement and validation
- **Format Conversion** - On-the-fly conversion between formats
- **Reading Progress** - Track reading progress across devices
- **Tag Management** - Smart tagging and categorization
- **Library Statistics** - Detailed insights into your collection

### AI-Powered Tools
- **Book Recommendations** - Get personalized book suggestions based on content similarity
- **Content Analysis** - Extract entities, themes, and sentiment from book content
- **Reading Insights** - Analyze your reading habits and preferences
- **Metadata Enhancement** - AI-assisted metadata correction and enrichment

### Advanced Series Management
- **Series Analysis** - Identify and fix issues in book series
- **Metadata Validation** - Ensure consistency across your library
- **Series Merging** - Combine duplicate or related series
- **Automatic Organization** - Keep your series properly ordered and managed

## Usage Examples

### Search Examples

**Using Portmanteau Tools:** All user queries (search, list, find, query, get) map to `query_books`:

```python
# User says: "list books by conan doyle" ‚Üí query_books with operation="search"
results = await query_books(
    operation="search",
    author="Conan Doyle",
    format_table=True
)

# Search by title, author, or series
results = await query_books(
    operation="search",
    text="python programming"
)

# Filter by date ranges
from datetime import datetime, timedelta
last_month = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
today = datetime.now().strftime("%Y-%m-%d")
results = await query_books(
    operation="search",
    pubdate_start="2020-01-01",
    added_after=last_month,
    added_before=today
)

# Filter by file size and format
results = await query_books(
    operation="search",
    min_size=1048576,    # 1MB
    max_size=10485760,   # 10MB
    formats=["EPUB", "PDF"]
)

# Find books with empty comments or no publisher
results = await query_books(
    operation="search",
    has_empty_comments=True,
    has_publisher=False
)

# Find highly rated books
results = await query_books(operation="search", min_rating=4)

# Find unrated books
results = await query_books(operation="search", unrated=True)

# Find books by publisher
results = await query_books(operation="search", publisher="O'Reilly Media")

# Combined search with multiple filters
results = await query_books(
    operation="search",
    text="machine learning",
    min_rating=4,
    pubdate_start="2020-01-01",
    formats=["EPUB"],
    limit=20,
    offset=0
)

# List all books (simple operation, no filters)
results = await query_books(operation="list", limit=50)
```

### AI-Powered Recommendations
```python
# Get book recommendations based on a book
recommendations = await get_book_recommendations(book_id="123")

# Get personalized recommendations based on preferences
preferences = {
    "favorite_authors": ["Brandon Sanderson", "N.K. Jemisin"],
    "favorite_genres": ["Fantasy", "Science Fiction"]
}
personalized_recs = await get_book_recommendations(user_preferences=preferences)
```

### Content Analysis
```python
# Analyze book content
analysis = await analyze_book_content(
    book_content="...",
    options={
        "extract_entities": True,
        "analyze_sentiment": True,
        "identify_themes": True
    }
)
```

### Series Management
```python
# Analyze series in your library
analysis = await analyze_series(
    library_path="/path/to/calibre/library",
    update_metadata=True
)

# Fix common series metadata issues
fix_results = await fix_series_metadata(
    library_path="/path/to/calibre/library",
    dry_run=False
)

# Merge two series
merge_results = await merge_series(
    library_path="/path/to/calibre/library",
    source_series="The Kingkiller Chronicle",
    target_series="Kingkiller Chronicle",
    dry_run=True
)
```

## Documentation

Full documentation available at [docs/](docs/).

## Testing

```bash
# Unit tests
python -m pytest tests/test_api.py -v

# Integration tests  
python -m pytest tests/integration_tests.py -v

# MCP Inspector
python -m calibre_mcp.server
# Opens: http://127.0.0.1:6274
```

## üîß Configuration

### **Environment Variables**

```env
CALIBRE_SERVER_URL=http://localhost:8080
CALIBRE_USERNAME=your_username      # If auth enabled
CALIBRE_PASSWORD=your_password      # If auth enabled
CALIBRE_TIMEOUT=30
CALIBRE_DEFAULT_LIMIT=50
```

### **With Authentication**

```bash
# Enable Calibre authentication
calibre-server --port=8080 --enable-auth --manage-users

# Add user and set environment
export CALIBRE_USERNAME="sandra"
export CALIBRE_PASSWORD="your_password"
```

## üö® Troubleshooting

### **Connection Failed**

```bash
# Check if Calibre server is running
netstat -an | findstr 8080  # Windows
curl http://localhost:8080  # Test in browser
```

### **No Books Found**

```bash
# Verify library has books
calibredb list --limit=5

# Check library path
calibre-debug --get-library
```

### **Authentication Issues**

```bash
# Test credentials
curl -u username:password http://localhost:8080/ajax/interface-data/init
```

See **[Troubleshooting Guide](docs/Troubleshooting.md)** for comprehensive solutions.

## üèó Architecture

```
calibremcp/
‚îú‚îÄ‚îÄ src/calibre_mcp/
‚îÇ   ‚îú‚îÄ‚îÄ server.py           # 4 FastMCP tools
‚îÇ   ‚îú‚îÄ‚îÄ calibre_api.py      # HTTP API client
‚îÇ   ‚îî‚îÄ‚îÄ config.py           # Configuration management
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ settings.yaml       # Server configuration
‚îÇ   ‚îî‚îÄ‚îÄ calibre_config.yaml # Calibre-specific settings
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_api.py         # Unit tests
‚îÇ   ‚îî‚îÄ‚îÄ integration_tests.py # Integration tests
‚îî‚îÄ‚îÄ docs/                   # Complete documentation
```

## üíØ Success Metrics

### **Phase 1 Complete** ‚úÖ

- ‚úÖ 4/4 core MCP tools implemented and tested
- ‚úÖ FastMCP 2.0 compliance with proper structure  
- ‚úÖ Comprehensive error handling and diagnostics
- ‚úÖ Austrian efficiency: 45-minute realistic timeline
- ‚úÖ Production-ready for immediate Claude Desktop use

## üìÑ License

MIT License - Austrian efficiency in e-book management.

---

**Built with Austrian efficiency for Sandra's comprehensive e-book workflow.**

*"Sin temor y sin esperanza" - practical without hype or doom.*
